<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Breadcrumb → DynamoDB loader</title>

  <!-- ❶  nothing to import – we embed server‑side now -->

  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; }
    pre  { background:#f5f5f5; padding:1rem; border-radius:4px; white-space:pre-wrap; }
  </style>
</head>
<body>
<h1>Upload taxonomy JSON → DynamoDB</h1>

<label>JSON taxonomy
  <textarea id="jsonInput" rows="12" style="width:100%">
{
  "indexes": {
    "agriculture": ["agriculture"],
    "architecture": ["architecture"],
    "biology": ["biology"],
    "business": ["business"],
    "characteristic": ["characteristic"],
    "chemistry": ["chemistry"],
    "community": ["community"],
    "cosmology": ["cosmology"],
    "economics": ["economics"],
    "education": ["education"],
    "entertainment": ["entertainment"],
    "environment": ["environment"],
    "event": ["event"],
    "food": ["food"],
    "geology": ["geology"],
    "geography": ["geography"],
    "government": ["government"],
    "health": ["health"],
    "history": ["history"],
    "language": ["language"],
    "law": ["law"],
    "manufacturing": ["manufacturing"],
    "mathematics": ["mathematics"],
    "people": ["people"],
    "psychology": ["psychology"],
    "philosophy": ["philosophy"],
    "religion": ["religion"],
    "sports": ["sports"],
    "technology": ["technology"],
    "transportation": ["transportation"]
  }
}
  </textarea>
</label>
<br>
<button id="goBtn">Process &amp; upload</button>

<p id="status">Ready ✔</p>
<pre id="log"></pre>
<label>Generated embedding index
  <textarea id="outJson" rows="12" style="width:100%"></textarea>
</label>
<script type="module">
  const $btn   = document.getElementById('goBtn');
  const $stat  = document.getElementById('status');
  const $log   = document.getElementById('log');
  const $out   = document.getElementById('outJson');

  /** POST `text` → /embed → { embedding:[…] } */
  async function getEmbedding(text) {
    const res  = await fetch('/embed', {
      method : 'POST',
      headers: { 'Content-Type':'application/json' },
      body   : JSON.stringify({ text })
    });
    if (!res.ok) throw new Error(`embed HTTP ${res.status}`);
    const { embedding } = await res.json();
    if (!embedding)     throw new Error('missing "embedding" in /embed reply');
    return embedding;
  }

  $btn.addEventListener('click', async () => {
    let src;
    try {
      src = JSON.parse(document.getElementById('jsonInput').value);
    } catch {
      return alert('Bad JSON');
    }

    const out = { indexes: {} };

    const idx = src.indexes ?? {};
    for (const [category, paths] of Object.entries(idx)) {
      if (!paths.length) continue;          // nothing to do
      // use the first breadcrumb string for the embedding
      const text = paths[0];

      $stat.textContent = `Embedding “${text}”…`;
      try {
        out.indexes[category] = await getEmbedding(text);
        $log.textContent += `✔ ${category}\n`;
      } catch (err) {
        console.error(err);
        $log.textContent += `❌ ${category}: ${err.message}\n`;
      }
    }

    $stat.textContent  = 'Done ✔';
    $out.value         = JSON.stringify(out, null, 2);
    $out.select();               // highlight for easy copy
  });
</script>

</body>
</html>
