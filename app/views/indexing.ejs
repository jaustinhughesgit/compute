<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Breadcrumb → DynamoDB loader</title>

  <!-- ❶  nothing to import – we embed server‑side now -->

  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; }
    pre  { background:#f5f5f5; padding:1rem; border-radius:4px; white-space:pre-wrap; }
  </style>
</head>
<body>
<h1>Upload taxonomy JSON → DynamoDB</h1>

<label>JSON taxonomy
  <textarea id="jsonInput" rows="12" style="width:100%">
{
  "indexes": {
    "agriculture": ["agriculture"],
    "architecture": ["architecture"],
    "biology": ["biology"],
    "business": ["business"],
    "characteristic": ["characteristic"],
    "chemistry": ["chemistry"],
    "community": ["community"],
    "cosmology": ["cosmology"],
    "economics": ["economics"],
    "education": ["education"],
    "entertainment": ["entertainment"],
    "environment": ["environment"],
    "event": ["event"],
    "food": ["food"],
    "geology": ["geology"],
    "geography": ["geography"],
    "government": ["government"],
    "health": ["health"],
    "history": ["history"],
    "language": ["language"],
    "law": ["law"],
    "manufacturing": ["manufacturing"],
    "mathematics": ["mathematics"],
    "people": ["people"],
    "psychology": ["psychology"],
    "philosophy": ["philosophy"],
    "religion": ["religion"],
    "sports": ["sports"],
    "technology": ["technology"],
    "transportation": ["transportation"]
  }
}
  </textarea>
</label>
<br>
<button id="goBtn">Process &amp; upload</button>

<p id="status">Ready ✔</p>
<pre id="log"></pre>

<script type="module">
  const $btn  = document.getElementById('goBtn');
  const $stat = document.getElementById('status');
  const $log  = document.getElementById('log');

  /**
   * POST text → /embed  → { embedding:[…] }
   * (Your server route must include the raw vector in the JSON it returns.)
   */
  async function getEmbedding(text) {
    const res = await fetch('/embed', {
      method : 'POST',
      headers: { 'Content-Type': 'application/json' },
      body   : JSON.stringify({ text })
    });

    if (!res.ok) {
      throw new Error(`embed HTTP ${res.status}`);
    }

    const json = await res.json();
    if (!json.embedding) {
      throw new Error('No "embedding" field in /embed response');
    }
    return json.embedding;           // plain JS array
  }

  $btn.addEventListener('click', async () => {
    let taxo;
    try {
      taxo = JSON.parse(document.getElementById('jsonInput').value);
    } catch {
      return alert('Bad JSON');
    }

    const indexes = taxo.indexes ?? {};
    for (const [category, breadcrumbs] of Object.entries(indexes)) {

      const paths = [];
      for (const path of breadcrumbs) {
        $stat.textContent = `Embedding “${path}” …`;
        try {
          const emb = await getEmbedding(path);
          paths.push({ p: path, emb });
        } catch (err) {
          console.error(err);
          $log.textContent += `❌  failed embedding ${path}: ${err.message}\n`;
        }
      }

      // nothing to send?
      if (!paths.length) continue;

      $stat.textContent = `POSTing ${category} (${paths.length}) …`;
      const res = await fetch('/api/ingest', {
        method : 'POST',
        headers: { 'Content-Type':'application/json' },
        body   : JSON.stringify({
                  category,
                  root : category.toLowerCase(),
                  paths
                })
      }).then(r => r.json());

      $log.textContent += `✔ stored ${category} → ${JSON.stringify(res)}\n`;
    }

    $stat.textContent = 'All done ✔';
  });
</script>
</body>
</html>
